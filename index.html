<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LBM D2Q9 – Profil de Joukowsky</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #0a0e27; color: #e5e7eb; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    header { padding: 10px 20px; background: #0f172a; border-bottom: 1px solid #1e293b; }
    header h1 { font-size: 18px; margin: 0; color: #60a5fa; }
    main { flex: 1; display: flex; min-height: 0; }
    #sim-container { flex: 1; background: #020617; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }
    canvas { image-rendering: pixelated; max-width: 100%; max-height: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    #controls { width: 320px; background: #0f172a; border-left: 1px solid #1e293b; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
    .control-group { display: flex; flex-direction: column; gap: 5px; }
    label { font-size: 12px; color: #94a3b8; display: flex; justify-content: space-between; }
    span.val { color: #60a5fa; font-weight: bold; }
    input[type=range] { width: 100%; cursor: pointer; }
    button { padding: 10px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    button:hover { background: #1d4ed8; }
    button.secondary { background: #334155; }
    .stats { background: #1e293b; padding: 10px; border-radius: 6px; font-size: 12px; display: flex; flex-direction: column; gap: 5px; }
    .row { display: flex; justify-content: space-between; }
    .startup-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999; display:flex; justify-content:center; align-items:center; }
    .modal-box { background:#1e293b; padding:30px; border-radius:12px; text-align:center; max-width:400px; border:1px solid #334155; }
    select { padding: 5px; background: #1e293b; color: white; border: 1px solid #334155; border-radius: 4px; width: 100%; margin-top: 5px; }
  </style>
</head>
<body>

<div id="startup-modal" class="startup-modal">
  <div class="modal-box">
    <h2 style="color:#60a5fa; margin-top:0;">Simulateur LBM D2Q9</h2>
    <p>Solveur de Navier-Stokes en JavaScript (CPU).</p>
    <button id="start-btn" style="width:100%;">Démarrer</button>
  </div>
</div>

<header>
  <h1>Virtual Wind Tunnel (LBM)</h1>
</header>

<main>
  <div id="sim-container">
    <canvas id="sim-canvas"></canvas>
  </div>

  <aside id="controls">
    <div class="control-group">
      <label>Visualisation</label>
      <select id="viz-mode">
        <option value="vorticity">Vorticité (Tourbillons)</option>
        <option value="velocity">Vitesse</option>
        <option value="pressure">Pression</option>
        <option value="vectors">Vecteurs</option>
      </select>
    </div>

    <div class="control-group">
      <label>Vitesse (Mach) <span id="val-mach" class="val">0.10</span></label>
      <input type="range" id="mach" min="0.01" max="0.2" step="0.01" value="0.10">
    </div>

    <div class="control-group">
      <label>Viscosité (Tau) <span id="val-tau" class="val">0.60</span></label>
      <input type="range" id="tau" min="0.51" max="1.0" step="0.01" value="0.60">
    </div>

    <div class="control-group">
      <label>Angle d'Attaque <span id="val-aoa" class="val">15°</span></label>
      <input type="range" id="aoa" min="-20" max="40" step="1" value="15">
    </div>
    
    <div class="stats">
      <div class="row"><span>Reynolds</span><span id="reynolds">0</span></div>
      <div class="row"><span>FPS</span><span id="fps">0</span></div>
    </div>

    <button id="reset-btn" class="secondary">Réinitialiser Simulation</button>
  </aside>
</main>

<script>
const canvas = document.getElementById('sim-canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

// Paramètres LBM D2Q9
let Nx = 400, Ny = 160;
const Q = 9;
// Poids et vecteurs D2Q9
const w = [4/9, 1/9, 1/9, 1/9, 1/9, 1/36, 1/36, 1/36, 1/36];
const cx = [0, 1, 0, -1, 0, 1, -1, -1, 1];
const cy = [0, 0, 1, 0, -1, 1, 1, -1, -1];
const opp = [0, 3, 4, 1, 2, 7, 8, 5, 6];

let f, fTmp, rho, ux, uy, mask, vort, imgData, pixels;
let running = false;
let mach = 0.1, tau = 0.60;
let vizMode = 'vorticity';

function initMemory() {
  canvas.width = Nx; canvas.height = Ny;
  const size = Nx * Ny;
  f = new Float32Array(Q * size);
  fTmp = new Float32Array(Q * size);
  rho = new Float32Array(size);
  ux = new Float32Array(size);
  uy = new Float32Array(size);
  mask = new Uint8Array(size);
  vort = new Float32Array(size);
  imgData = ctx.createImageData(Nx, Ny);
  pixels = imgData.data;
}

function createAirfoil() {
  const size = Nx * Ny;
  for(let i=0; i<size; i++) mask[i] = 0;
  // Murs haut/bas
  for(let x=0; x<Nx; x++) { mask[x]=1; mask[x+(Ny-1)*Nx]=1; }
  
  // Joukowsky
  const aoaDeg = parseFloat(document.getElementById('aoa').value);
  const aoa = aoaDeg * Math.PI / 180;
  const R = Ny/6; // Rayon approx
  const cx_foil = Nx/4, cy_foil = Ny/2;
  
  // Scan simple pour remplir la forme
  for(let y=0; y<Ny; y++) {
    for(let x=0; x<Nx; x++) {
       // Forme goutte simple rotative pour robustesse
       let dx = x - cx_foil;
       let dy = y - cy_foil;
       // Rotation inverse
       let rx = dx*Math.cos(-aoa) - dy*Math.sin(-aoa);
       let ry = dx*Math.sin(-aoa) + dy*Math.cos(-aoa);
       
       // Forme Joukowsky approx (goutte)
       // Equation implicite grossière pour la démo
       let d = Math.sqrt(rx*rx + ry*ry*4.0); // écrasé en Y
       if(rx > 0) d += rx * 0.1; // queue
       if (d < R) mask[x + y*Nx] = 1;
    }
  }
}

function initSim() {
  const size = Nx * Ny;
  const u0 = mach * 0.577;
  for(let i=0; i<size; i++) {
    rho[i] = 1.0;
    ux[i] = mask[i] ? 0 : u0;
    uy[i] = 0;
    // Equilibre
    const u2 = ux[i]*ux[i] + uy[i]*uy[i];
    for(let k=0; k<Q; k++) {
      const cu = 3*(cx[k]*ux[i] + cy[k]*uy[i]);
      f[k*size+i] = w[k]*rho[i]*(1 + cu + 0.5*cu*cu - 1.5*u2);
    }
  }
}

function lbmStep() {
  const size = Nx * Ny;
  const uIn = mach * 0.577;

  // 1. Collision
  for(let i=0; i<size; i++) {
    if(mask[i]) continue;
    
    // Macros
    let r=0, u=0, v=0;
    for(let k=0; k<Q; k++) {
      const val = f[k*size+i];
      r += val;
      u += val*cx[k];
      v += val*cy[k];
    }
    
    // Inlet gauche
    const x = i % Nx;
    if(x===0) { r=1.0; u=uIn; v=0; }
    
    rho[i] = r;
    if(r>0) { ux[i] = u/r; uy[i] = v/r; }

    // Relax
    const u2 = ux[i]*ux[i] + uy[i]*uy[i];
    for(let k=0; k<Q; k++) {
       const cu = 3*(cx[k]*ux[i] + cy[k]*uy[i]);
       const feq = w[k]*r*(1 + cu + 0.5*cu*cu - 1.5*u2);
       fTmp[k*size+i] = f[k*size+i] - (f[k*size+i] - feq)/tau;
    }
  }

  // 2. Streaming + BounceBack
  for(let y=0; y<Ny; y++) {
    for(let x=0; x<Nx; x++) {
      const i = x + y*Nx;
      for(let k=0; k<Q; k++) {
        const xp = x - cx[k];
        const yp = y - cy[k];
        if(xp>=0 && xp<Nx && yp>=0 && yp<Ny) {
           const ip = xp + yp*Nx;
           if(mask[i]) { 
             // Rien (mur)
           } else if(mask[ip]) {
             f[k*size+i] = fTmp[opp[k]*size+i]; // Rebond
           } else {
             f[k*size+i] = fTmp[k*size+ip]; // Transport
           }
        }
      }
    }
  }
  
  // Vorticité
  for(let y=1; y<Ny-1; y++) {
      for(let x=1; x<Nx-1; x++) {
          const i = x + y*Nx;
          if(!mask[i]) vort[i] = (uy[i+1] - uy[i-1]) - (ux[i+Nx] - ux[i-Nx]);
          else vort[i] = 0;
      }
  }
}

function draw() {
  const size = Nx * Ny;
  for(let i=0; i<size; i++) {
     const p = i*4;
     if(mask[i]) {
        pixels[p]=100; pixels[p+1]=100; pixels[p+2]=100; pixels[p+3]=255;
     } else {
        let val = 0;
        let r=0, g=0, b=0;
        
        if(vizMode === 'vorticity') {
           val = vort[i] * 150; // scale
           // Diverging Blue-White-Red
           r = val > 0 ? 255 : 255 + val;
           b = val < 0 ? 255 : 255 - val;
           g = 255 - Math.abs(val);
        } else if(vizMode === 'velocity') {
           val = Math.sqrt(ux[i]**2 + uy[i]**2) * 1000;
           r = val; g = val/2; b = 255-val; // Heatmap simple
        } else {
           // Pressure
           val = (rho[i]-1.0) * 2000;
           r = val > 0 ? 255 : 0;
           b = val < 0 ? 255 : 0;
           g = 100;
        }
        
        pixels[p] = Math.min(255, Math.max(0, r));
        pixels[p+1] = Math.min(255, Math.max(0, g));
        pixels[p+2] = Math.min(255, Math.max(0, b));
        pixels[p+3] = 255;
     }
  }
  ctx.putImageData(imgData, 0, 0);
  
  // Overlay Vecteurs (Optionnel)
  if(vizMode === 'vectors') {
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.beginPath();
    for(let y=0; y<Ny; y+=10) {
       for(let x=0; x<Nx; x+=10) {
          const i = x+y*Nx;
          if(!mask[i]) {
             ctx.moveTo(x,y);
             ctx.lineTo(x+ux[i]*100, y+uy[i]*100);
          }
       }
    }
    ctx.stroke();
  }
}

let lastT = 0;
function loop(t) {
  if(!running) return;
  // Multi-step
  for(let k=0; k<4; k++) lbmStep();
  draw();
  
  // Stats
  if(t - lastT > 500) {
     document.getElementById('fps').innerText = (1000/(t-lastT)*4).toFixed(0);
     const Re = (mach * 0.577 * Ny/6) / ((tau-0.5)/3);
     document.getElementById('reynolds').innerText = Re.toFixed(0);
     lastT = t;
  }
  requestAnimationFrame(loop);
}

// UI Bindings
document.getElementById('start-btn').onclick = () => {
  document.getElementById('startup-modal').style.display = 'none';
  initMemory();
  createAirfoil();
  initSim();
  running = true;
  loop(0);
};

document.getElementById('reset-btn').onclick = () => {
  running = false;
  initMemory();
  createAirfoil();
  initSim();
  running = true;
  loop(0);
};

document.getElementById('mach').oninput = (e) => { mach = parseFloat(e.target.value); document.getElementById('val-mach').innerText = mach; };
document.getElementById('tau').oninput = (e) => { tau = parseFloat(e.target.value); document.getElementById('val-tau').innerText = tau; };
document.getElementById('aoa').oninput = (e) => { 
   document.getElementById('val-aoa').innerText = e.target.value + '°'; 
   createAirfoil(); // Update geo en live
};
document.getElementById('viz-mode').onchange = (e) => { vizMode = e.target.value; };

</script>
</body>
</html>
